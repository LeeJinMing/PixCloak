name: IndexNow Auto Submit

# 在以下情况自动提交到 IndexNow：
# 1. 每次推送到 main 分支
# 2. 每天定时运行一次（确保新内容被索引）
# 3. 可手动触发

on:
  push:
    branches: [main]
    paths:
      - "app/**/*.tsx"
      - "app/**/*.ts"
      - "app/**/page.tsx"
      - "lib/**"
  schedule:
    # 每天 UTC 时间 2:00（北京时间 10:00）运行
    - cron: "0 2 * * *"
  workflow_dispatch: # 允许手动触发

jobs:
  submit-indexnow:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: 安装依赖
        working-directory: ./web
        run: npm ci

      - name: 提交所有 URLs 到 IndexNow
        working-directory: ./web
        env:
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://pixcloak.com' }}
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
          BATCH_SIZE: 100
          DELAY_MS: 2000
        run: |
          echo "开始提交 URLs 到 IndexNow..."
          node ./scripts/submit-indexnow-all.mjs
          echo "✅ IndexNow 提交完成"

      - name: 通知 Bing Webmaster Tools
        working-directory: ./web
        env:
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://pixcloak.com' }}
        run: |
          echo "通知 Bing 网站地图更新..."
          curl -f "https://www.bing.com/ping?sitemap=${NEXT_PUBLIC_SITE_URL}/sitemap.xml" || true
          curl -f "https://www.bing.com/ping?sitemap=${NEXT_PUBLIC_SITE_URL}/guides/sitemap.xml" || true
          echo "✅ Bing 通知完成"

      - name: 输出统计信息
        run: |
          echo "🎉 IndexNow 自动提交工作流完成！"
          echo "📊 已提交网站所有 URL 到搜索引擎"
          echo "⏰ 下次自动运行: 明天 UTC 2:00"
